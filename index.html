<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªé¢¨Webã‚«ãƒ¡ãƒ©</title>
<style>
  body { display:flex; flex-direction:column; align-items:center; font-family:sans-serif; }
  video { width: 100%; max-width: 480px; border-radius: 10px; }
  canvas { display:none; }
  .controls { margin-top: 10px; display:flex; gap:10px; }
  button { padding:10px 20px; border-radius:5px; font-size:16px; }
</style>
</head>
<body>

<h1>Webã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒª</h1>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" width="480" height="360"></canvas>

<div class="controls">
  <button id="photoBtn">ğŸ“¸ å†™çœŸ</button>
  <button id="recordBtn">âºï¸ éŒ²ç”»</button>
  <button id="switchBtn">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
</div>
<a id="downloadLink" style="display:none">ä¿å­˜</a>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let photoBtn = document.getElementById('photoBtn');
let recordBtn = document.getElementById('recordBtn');
let switchBtn = document.getElementById('switchBtn');
let downloadLink = document.getElementById('downloadLink');

let stream;
let mediaRecorder;
let recordedChunks = [];
let devices = [];
let currentCameraIndex = 0;
let isRecording = false;

// ã‚«ãƒ¡ãƒ©ä¸€è¦§å–å¾—
async function getCameras() {
  const allDevices = await navigator.mediaDevices.enumerateDevices();
  devices = allDevices.filter(d => d.kind === 'videoinput');
}
  
// ã‚«ãƒ¡ãƒ©èµ·å‹•
async function startCamera(deviceId = null) {
  if (stream) stream.getTracks().forEach(track => track.stop());
  const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "user" }, audio: true };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream;
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); }
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type:"video/webm" });
    recordedChunks = [];
    const url = URL.createObjectURL(blob);
    downloadLink.href = url;
    downloadLink.download = "video.webm";
    downloadLink.style.display = "inline";
    downloadLink.textContent = "å‹•ç”»ä¿å­˜";
  };
}

// åˆæœŸåŒ–
getCameras().then(() => startCamera());

// å†™çœŸæ’®å½±
photoBtn.addEventListener('click', () => {
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/png');
  downloadLink.href = dataUrl;
  downloadLink.download = 'photo.png';
  downloadLink.style.display = 'inline';
  downloadLink.textContent = 'å†™çœŸä¿å­˜';
});

// éŒ²ç”»é–‹å§‹/åœæ­¢
recordBtn.addEventListener('click', () => {
  if(!isRecording) {
    recordedChunks = [];
    mediaRecorder.start();
    recordBtn.textContent = 'â¹ï¸ åœæ­¢';
    isRecording = true;
    downloadLink.style.display = 'none';
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = 'âºï¸ éŒ²ç”»';
    isRecording = false;
  }
});

// ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
switchBtn.addEventListener('click', () => {
  if(devices.length <= 1) return;
  currentCameraIndex = (currentCameraIndex + 1) % devices.length;
  startCamera(devices[currentCameraIndex].deviceId);
});
</script>

</body>
</html>
