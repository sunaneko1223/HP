<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Web„Ç´„É°„É©</title>
<style>
  html, body {
    margin:0; padding:0;
    height:100%;
    overflow:hidden;
    font-family:sans-serif;
    background:black;
    display:flex;
    flex-direction:column;
  }
  #video {
    width:100%;
    height:100%;
    object-fit:cover;
    position:absolute;
    top:0; left:0;
    z-index:0;
  }
  .controls {
    position:absolute;
    bottom:20px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:40px;
    z-index:1;
    pointer-events:auto;
  }
  button {
    width:90px;
    height:90px;
    border-radius:50%;
    border:none;
    background:white;
    font-size:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    cursor:pointer;
  }
  button:active {
    transform: scale(0.95);
  }
  #recordBtn.recording {
    background:red;
  }
  #downloadLink {
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    color:white;
    background:rgba(0,0,0,0.5);
    padding:10px 20px;
    border-radius:10px;
    text-decoration:none;
    z-index:2;
  }
  canvas { display:none; }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" width="480" height="360"></canvas>

<div class="controls">
  <button id="photoBtn">üì∏</button>
  <button id="recordBtn">‚è∫Ô∏è</button>
  <button id="switchBtn">üîÑ</button>
</div>

<a id="downloadLink" style="display:none"></a>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let photoBtn = document.getElementById('photoBtn');
let recordBtn = document.getElementById('recordBtn');
let switchBtn = document.getElementById('switchBtn');
let downloadLink = document.getElementById('downloadLink');

let stream;
let mediaRecorder;
let recordedChunks = [];
let devices = [];
let currentCameraIndex = 0;
let isRecording = false;

// „Ç´„É°„É©‰∏ÄË¶ßÂèñÂæó
async function getCameras() {
  const allDevices = await navigator.mediaDevices.enumerateDevices();
  devices = allDevices.filter(d => d.kind === 'videoinput');
}

// „Ç´„É°„É©Ëµ∑ÂãïÔºàÊúÄÂàù„ÅØËÉåÈù¢„Ç´„É°„É©Ôºâ
async function startCamera(deviceId = null) {
  if (stream) stream.getTracks().forEach(track => track.stop());
  const constraints = { 
    video: deviceId 
      ? { deviceId: { exact: deviceId } } 
      : { facingMode: { exact: "environment" } }, 
    audio: true 
  };
  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); }
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type:"video/webm" });
      recordedChunks = [];
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = "video.webm";
      downloadLink.style.display = "inline";
      downloadLink.textContent = "ÂãïÁîª‰øùÂ≠ò";
    };
  } catch(err) {
    console.error("„Ç´„É°„É©„ÇíÈñã„Åë„Åæ„Åõ„Çì: ", err);
  }
}

// ÂàùÊúüÂåñ
getCameras().then(() => startCamera());

// ÂÜôÁúüÊíÆÂΩ±ÔºàÈå≤Áîª‰∏≠„Åß„ÇÇÂèØËÉΩÔºâ
photoBtn.addEventListener('click', () => {
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/png');
  downloadLink.href = dataUrl;
  downloadLink.download = 'photo.png';
  downloadLink.style.display = 'inline';
  downloadLink.textContent = 'ÂÜôÁúü‰øùÂ≠ò';
});

// Èå≤ÁîªÈñãÂßã/ÂÅúÊ≠¢
recordBtn.addEventListener('click', () => {
  if(!isRecording) {
    recordedChunks = [];
    mediaRecorder.start();
    recordBtn.classList.add('recording');
    isRecording = true;
    downloadLink.style.display = 'none';
  } else {
    mediaRecorder.stop();
    recordBtn.classList.remove('recording');
    isRecording = false;
  }
});

// „Ç´„É°„É©ÂàáÊõø
switchBtn.addEventListener('click', () => {
  if(devices.length <= 1) return;
  currentCameraIndex = (currentCameraIndex + 1) % devices.length;
  startCamera(devices[currentCameraIndex].deviceId);
});
</script>

</body>
</html>
